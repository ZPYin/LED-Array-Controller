## MODBUS方案的开发需求

### 开发问题

1. LED都是固定亮度？只需要ON/OFF？现在LED项目整体的方案大概如何？
2. 需要控制哪些东西？需要查询什么信息？
3. 获取LED状态是发送一条查询命令，然后就能得到返回值吗？返回值需要做单位转换吗？

协议问题：

1. 备用开关1-9地址与LED控制开关地址重合
2. 从站ABC中LED（26-30）功率读取地址可能出现错误

### 需要开发的功能

1. 控制（每个从站）30个LED的开关
2. 控制（每个从站）4个可变亮度LED的功率
3. 读取（每个从站）30个LED的光强、电压和电流
4. 控制冷水机和水泵的开关（某一个）
5. 读取冷水机和水泵的报警状态
6. 控制3个天窗的开关（八路继电器中的某三个）
7. 定时保存状态

### Bug问题

#### 2023-01-07

修正：可调led只能开，不能关
修正：上位机查询led状态时发完指令就闪退（包括电压电流）
修正：冷水机电源开关指令、灯总开关指令、转台电源指令、空调开关指令的开和关发送的都是开的指令
修正：站号这边装的是绿1，红2，红外3
修正-添加灯总开关开的指令：泰润这边在开灯前需要先打开灯总开关指令。这个灯总开关相当于led灯的一种颜色的总闸。每个颜色都有一个灯总开关，地址均为H1F
额外疑问：话说每个颜色灯的总开关在协议上是说常闭触点，请确认可以进行开关操作

问题：“led的状态”一直是“获取led状态失败”
回答：请用串口工具查看led状态的返回字节，原协议中并没有定义返回结果，我是按照网络上说得ModBus返回状态进行的结果解析，可能解析结果有问题。请提供一个返回结果的样例，以便于debug。

问题：温度没有显示
回答：同上

额外的问题

- 需要反馈设置功率到发送指令的换算问题

### 串口调试

- 虚拟串口产生，使用Virtual Null Modem定义一个串口对
- 使用串口调试工具挂载到上述的串口对中，其中自己的串口连接程序挂在到串口对的另外一端

### MODUS协议（C#）

> 如下参考自https://blog.csdn.net/weixin_41010091/article/details/108454485

MODUS是一个工业上常用的通讯协议，主要用于控制器之间通信或者控制器通过以太网和其他设备（如PC）之间通信。

MODUS规定了两种字符传输模式，ASCII模式和RTU（二进制）模式，两种模式不能混用。

RTU模式采用循环冗余校验，当检验出错时，报文停止处理从机不再继续通信，不对此报文产生回应，主机在一定时间过后未收到从站回答，即做出“通信错误已发生”的判断。

**1.读取输出线圈 功能码0x01**

Tx：01 01 00 00 00 0A BC 0D

从站地址(0x01) + 功能码(0x01) + 起始地址(高位0x00 低位0x00) + 线圈数(高位0x00 低位0x0A) + CRC(0xBC 0x0D)

功能：读取1号从站输出线圈00001-00010，共10个线圈状态。

Rx：01 01 02 0F 00 BC 0C

从站地址(0x01) + 功能码(0x01) + 字节数(0x02) + 线圈状态1-8(0x0F) + 线圈状态9-10 (0x00) + CRC

功能：返回输出线圈状态，1个字节表示8个线圈状态，尾部不足则充余。

2.读取输入线圈   功能码0x02     

除开功能码以及起始地址表示含义，与上相同。



3.读取保持型寄存器   功能码0x03

Tx:01 03 00 00 00 0A C5 CD

从站地址（0x01）+功能码（0x03）+起始地址（高位0x00  低位0x00）+寄存器数量（0x00  0x0A）+CRC（0xC5  0xCD）

功能：读取1号从站保持寄存器40001-40010，共10个字(即20个字节，1个字=2个字节=16位)

Rx:01 03 14 00 37 00 2C 00 21 00 0A 00 00 00 00 00 00 00 00 00 00 00 00 7C CC

从站地址（0x01）+功能码（0x03）+字节数（0x14）+字节状态（00 37 00 2C 00 21 00 0A 00 00 00 00 00 00 00 00 00 00 00 00）+CRC（0x7C 0xCC）

功能：返回保持型寄存器状态

 

4.强制单线圈   功能码0x05

Tx:01 05 00 03 00 00 3D CA

从站地址（0x01）+功能码（0x05）+线圈地址（高位0x00  低位0x03）+操作数（0x00  0x00）+CRC（0x3D  0xCA）

功能：强制1号从站4号线圈位OFF状态，ON状态操作数即（0xFF  0x00）

Rx:01 05 00 03 00 00 3D CA

原报文返回

 

5.预置单保持型寄存器   功能码0x06

Tx:01 06 00 10 42 C8 76 69

从站地址（0x01）+功能码（0x06）+寄存器地址（高位0x00  0x10）+数据值（高位0x42  低位0xC8）+CRC（76 69）   

功能：预置1号从站40017号寄存器数据

Rx:01 06 00 10 42 C8 76 69

原文返回
           

6.预置多保持型寄存器   功能码0x10

Tx:01 10 00 00 00 02 04 42 C8 00 00 66 29

从站地址（0x01）+功能码（0x10）+起始地址（0x00  0x00）+寄存器数量（0x00  0x02）+字节数量（0x04）+预置数（0x42 0xC8  0x00  0x00）+CRC（0x66  0x29）           

功能：预置1号从站40001-40002号寄存器数据    

Rx:01 10 00 00 00 02 41 C8 

从站地址（0x01）+功能码（0x10）+起始地址（0x00  0x00）+寄存器数量（0x00  0x02）+CRC（0x41 0xC8）

功能：确认40001-40001预置成功